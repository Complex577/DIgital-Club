services:
  web:
    build: .
    ports:
      - "5051:5051"
    environment:
      FLASK_APP: main.py
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      BEEM_API_KEY: ${BEEM_API_KEY:-}
      BEEM_SECRET_KEY: ${BEEM_SECRET_KEY:-}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://digital_club_user:digital_club_password@db:5432/digital_club_db}
      PORT: 5051
      SMTP_SERVER: ${SMTP_SERVER:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      FROM_EMAIL: ${FROM_EMAIL:-}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
    volumes:
      - ./instance:/app/instance
      - ./app/static/uploads:/app/app/static/uploads
    dns:
      - 1.1.1.1
      - 8.8.8.8
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 5051)); s.close()\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - digital_club_network

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: digital_club_db
      POSTGRES_USER: digital_club_user
      POSTGRES_PASSWORD: digital_club_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - digital_club_network

volumes:
  postgres_data:

networks:
  digital_club_network:
    driver: bridge
