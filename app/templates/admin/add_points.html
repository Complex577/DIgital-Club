{% extends "admin/admin_base.html" %}

{% block admin_title %}Award Points{% endblock %}
{% block page_title %}Award Points{% endblock %}
{% block breadcrumb %}
<span class="breadcrumb-separator">/</span> 
<a href="{{ url_for('admin.members') }}">Members</a>
<span class="breadcrumb-separator">/</span>
<a href="{{ url_for('admin.member_detail', member_id=member.id) }}">{{ member.full_name }}</a>
<span class="breadcrumb-separator">/</span>
<span>Award Points</span>
{% endblock %}

{% block admin_content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="admin-card live-search-scope">
            <div class="admin-card-header">
                <h5><i class="fas fa-plus-circle"></i> Award/Deduct Points for {{ member.full_name }}</h5>
            </div>
            <div class="admin-card-body">
                <div class="mb-4">
                    <label class="form-label">Switch Member (Live Search)</label>
                    <div class="position-relative live-search-host">
                        <input type="text" id="member_switch_search" class="form-control" placeholder="Search member by name, email or ID..." autocomplete="off">
                        <div id="member_switch_loading" class="small text-muted mt-1 d-none">
                            <i class="fas fa-spinner fa-spin me-1"></i>Searching...
                        </div>
                        <div id="member_switch_results" class="list-group shadow-sm live-search-results"></div>
                    </div>
                </div>

                <div class="alert alert-info mb-4">
                    <strong>Current Points:</strong> {{ member.get_total_points() }}
                </div>

                <form method="POST">
                    <div class="mb-3">
                        <label class="form-label">Points Amount *</label>
                        <input type="number" 
                               name="points" 
                               class="form-control form-control-lg" 
                               placeholder="Enter points (positive to award, negative to deduct)"
                               required>
                        <small >Use positive numbers to award points, negative numbers to deduct</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Transaction Type *</label>
                        <select name="transaction_type" class="form-control" required>
                            <option value="manual">Manual Award/Deduction</option>
                            <option value="event_attendance">Event Attendance</option>
                            <option value="project_completion">Project Completion</option>
                            <option value="hackathon_win">Hackathon Win</option>
                            <option value="volunteer_work">Volunteer Work</option>
                            <option value="achievement">Special Achievement</option>
                            <option value="bonus">Bonus Points</option>
                            <option value="penalty">Penalty</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Reason *</label>
                        <textarea name="reason" 
                                  class="form-control" 
                                  rows="4" 
                                  placeholder="Explain why these points are being awarded or deducted" 
                                  required></textarea>
                        <small >Provide a clear description that will be visible to the member</small>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin.member_detail', member_id=member.id) }}" class="admin-btn admin-btn-outline">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="admin-btn admin-btn-primary">
                            <i class="fas fa-check"></i> Confirm Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-card mt-4">
            <div class="admin-card-header">
                <h6><i class="fas fa-bolt"></i> Quick Award Presets</h6>
            </div>
            <div class="admin-card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setPoints(50, 'Attended workshop')">
                            +50 Workshop Attendance
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="setPoints(100, 'Attended hackathon')">
                            +100 Hackathon Attendance
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-success w-100" onclick="setPoints(250, 'Won hackathon')">
                            +250 Hackathon Winner
                        </button>
                    </div>
                    <div class="col-md-6 mb-2">
                        <button class="btn btn-outline-success w-100" onclick="setPoints(150, 'Completed project')">
                            +150 Project Completion
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setPoints(points, reason) {
    document.querySelector('input[name="points"]').value = points;
    document.querySelector('textarea[name="reason"]').value = reason;
    if (points >= 100) {
        document.querySelector('select[name="transaction_type"]').value = 'achievement';
    }
}

(function () {
    const input = document.getElementById('member_switch_search');
    const results = document.getElementById('member_switch_results');
    const loading = document.getElementById('member_switch_loading');
    if (!input || !results || !loading) return;

    let timer = null;
    function clearResults() { results.innerHTML = ''; }

    function render(items) {
        clearResults();
        if (!items.length) {
            results.innerHTML = '<div class="list-group-item text-muted">No members found</div>';
            return;
        }
        items.forEach((item) => {
            const link = document.createElement('a');
            link.className = 'list-group-item list-group-item-action';
            link.href = item.add_points_url;
            link.innerHTML = `<strong>${item.full_name}</strong><br><small>${item.member_id_number} â€¢ ${item.email}</small>`;
            results.appendChild(link);
        });
    }

    input.addEventListener('input', function () {
        const q = this.value.trim();
        clearResults();
        if (!q) return;

        if (timer) clearTimeout(timer);
        timer = setTimeout(async () => {
            loading.classList.remove('d-none');
            try {
                const res = await fetch(`{{ url_for('admin.members_search') }}?q=${encodeURIComponent(q)}&limit=12`);
                const data = await res.json();
                render(data.results || []);
            } catch (e) {
                results.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
            } finally {
                loading.classList.add('d-none');
            }
        }, 260);
    });

    document.addEventListener('click', function (e) {
        if (!results.contains(e.target) && e.target !== input) clearResults();
    });
})();
</script>
{% endblock %}

