{% extends "admin/admin_base.html" %}

{% block admin_title %}Session{% endblock %}
{% block page_title %}{{ 'Edit Session' if session else 'Add Session' }}{% endblock %}
{% block breadcrumb %}<span class="breadcrumb-separator">/</span> <a href="{{ url_for('admin.sessions_index') }}">Sessions</a><span class="breadcrumb-separator">/</span> <a href="{{ url_for('admin.sessions_week_view', week_id=week.id) }}">Week</a><span class="breadcrumb-separator">/</span> <span>{{ 'Edit' if session else 'Add' }}</span>{% endblock %}

{% block admin_content %}
<div class="admin-card live-search-scope">
    <div class="admin-card-body live-search-scope">
        <form method="POST">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="admin-form-label">Session Date</label>
                    <input type="date" name="session_date" class="admin-form-control" value="{{ session.session_date.strftime('%Y-%m-%d') if session else '' }}" required>
                </div>
                <div class="col-md-6">
                    <label class="admin-form-label">Start Time</label>
                    <input type="time" name="start_time" class="admin-form-control" value="{{ session.start_time.strftime('%H:%M') if session else '' }}" required>
                </div>
                <div class="col-md-8">
                    <label class="admin-form-label">Topic</label>
                    <input type="text" name="topic" class="admin-form-control" value="{{ session.topic if session else '' }}" required>
                </div>
                <div class="col-md-4">
                    <label class="admin-form-label">Category</label>
                    <select name="category" class="admin-form-select" required>
                        <option value="">Select category</option>
                        {% for c in categories %}
                        <option value="{{ c }}" {% if session and session.category == c %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="admin-form-label">Mode</label>
                    <select name="mode" class="admin-form-select">
                        <option value="online" {% if session and session.mode == 'online' %}selected{% endif %}>Online</option>
                        <option value="physical" {% if session and session.mode == 'physical' %}selected{% endif %}>Physical</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="admin-form-label">Instructor</label>
                    {% set selected_instructor = (users | selectattr('id', 'equalto', session.instructor_user_id) | list | first) if session else None %}
                    <input type="hidden" name="instructor_user_id" id="instructor_user_id" value="{{ session.instructor_user_id if session else '' }}" required>
                    <div class="position-relative live-search-host">
                        <input type="text" id="instructor_search" class="admin-form-control" placeholder="Search instructor by name or email..." autocomplete="off" value="{% if selected_instructor %}{{ selected_instructor.member.full_name if selected_instructor.member else selected_instructor.email }}{% endif %}">
                        <div id="instructor_search_loading" class="small text-muted mt-1 d-none">
                            <i class="fas fa-spinner fa-spin me-1"></i>Searching...
                        </div>
                        <div id="instructor_search_results" class="list-group shadow-sm live-search-results"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="admin-form-label">Meeting Link (online)</label>
                    <input type="text" name="meeting_link" class="admin-form-control" value="{{ session.meeting_link if session else '' }}">
                </div>
                <div class="col-md-6">
                    <label class="admin-form-label">Location (physical)</label>
                    <input type="text" name="location" class="admin-form-control" value="{{ session.location if session else '' }}">
                </div>
                <div class="col-md-4">
                    <label class="admin-form-label">Teaching Minutes</label>
                    <input type="number" name="teaching_minutes" class="admin-form-control" value="{{ session.teaching_minutes if session else 60 }}">
                </div>
                <div class="col-md-4">
                    <label class="admin-form-label">Questions Minutes</label>
                    <input type="number" name="questions_minutes" class="admin-form-control" value="{{ session.questions_minutes if session else 15 }}">
                </div>
                <div class="col-md-4">
                    <label class="admin-form-label">Status</label>
                    <select name="status" class="admin-form-select">
                        <option value="scheduled" {% if session and session.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="completed" {% if session and session.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if session and session.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="admin-btn admin-btn-primary">
                    <i class="fas fa-save"></i> Save Session
                </button>
                <a href="{{ url_for('admin.sessions_week_view', week_id=week.id) }}" class="admin-btn admin-btn-outline ms-2">Back</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const input = document.getElementById('instructor_search');
    const hidden = document.getElementById('instructor_user_id');
    const results = document.getElementById('instructor_search_results');
    const loading = document.getElementById('instructor_search_loading');
    if (!input || !hidden || !results || !loading) return;

    let timer = null;

    function clearResults() { results.innerHTML = ''; }

    function render(items) {
        clearResults();
        if (!items.length) {
            results.innerHTML = '<div class="list-group-item text-muted">No users found</div>';
            return;
        }
        items.forEach((item) => {
            const row = document.createElement('button');
            row.type = 'button';
            row.className = 'list-group-item list-group-item-action';
            row.innerHTML = `<strong>${item.full_name}</strong><br><small>${item.email}</small>`;
            row.addEventListener('click', () => {
                hidden.value = item.user_id;
                input.value = `${item.full_name} (${item.email})`;
                clearResults();
            });
            results.appendChild(row);
        });
    }

    input.addEventListener('input', function () {
        hidden.value = '';
        const q = this.value.trim();
        clearResults();
        if (!q) return;

        if (timer) clearTimeout(timer);
        timer = setTimeout(async () => {
            loading.classList.remove('d-none');
            try {
                const res = await fetch(`{{ url_for('admin.members_search') }}?q=${encodeURIComponent(q)}&limit=12`);
                const data = await res.json();
                render(data.results || []);
            } catch (e) {
                results.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
            } finally {
                loading.classList.add('d-none');
            }
        }, 260);
    });

    document.addEventListener('click', function (e) {
        if (!results.contains(e.target) && e.target !== input) clearResults();
    });
})();
</script>
{% endblock %}
