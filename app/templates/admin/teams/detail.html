{% extends "admin/admin_base.html" %}

{% block admin_title %}Team{% endblock %}
{% block page_title %}{{ team.name }}{% endblock %}
{% block breadcrumb %}<span class="breadcrumb-separator">/</span> <a href="{{ url_for('admin.teams_index') }}">Teams</a><span class="breadcrumb-separator">/</span> <span>{{ team.name }}</span>{% endblock %}

{% block extra_head %}
{{ super() }}
<style>
    .team-add-member-card {
        position: relative;
        z-index: 40;
    }

    .team-add-member-card .live-search-host {
        position: relative;
        z-index: 41;
    }

    .team-members-card {
        position: relative;
        z-index: 1;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="admin-card mb-3 live-search-scope">
    <div class="admin-card-body">
        <form method="POST">
            <div class="row g-3">
                <div class="col-md-8">
                    <label class="admin-form-label">Description</label>
                    <textarea name="description" class="admin-form-control" rows="3">{{ team.description or '' }}</textarea>
                </div>
                <div class="col-md-4">
                    <label class="admin-form-label">Rating (0-5)</label>
                    <input type="number" name="rating" class="admin-form-control" min="0" max="5" value="{{ team.rating }}">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="admin-btn admin-btn-primary">Save Team</button>
            </div>
        </form>
    </div>
</div>

<div class="admin-card mb-3 live-search-scope team-add-member-card">
    <div class="admin-card-header">
        <h5>Add Member</h5>
    </div>
    <div class="admin-card-body live-search-scope">
        <form method="POST" action="{{ url_for('admin.teams_assign_member', team_id=team.id) }}" class="row g-2 align-items-end">
            <div class="col-md-8">
                <label class="admin-form-label">Member</label>
                <input type="hidden" name="member_id" id="team_member_id" required>
                <div class="position-relative live-search-host">
                    <input type="text" id="team_member_search" class="admin-form-control" placeholder="Search member by name, email or ID..." autocomplete="off">
                    <div id="team_member_loading" class="small text-muted mt-1 d-none">
                        <i class="fas fa-spinner fa-spin me-1"></i>Searching...
                    </div>
                    <div id="team_member_results" class="list-group shadow-sm live-search-results"></div>
                </div>
            </div>
            <div class="col-md-2">
                <label class="admin-form-label">Leader</label>
                <input type="checkbox" name="is_leader" class="form-check-input">
            </div>
            <div class="col-md-2">
                <button type="submit" class="admin-btn admin-btn-outline w-100">Assign</button>
            </div>
        </form>
    </div>
</div>

<div class="admin-card team-members-card">
    <div class="admin-card-header">
        <h5>Team Members</h5>
    </div>
    <div class="admin-card-body">
        <div class="admin-table-responsive">
            <table class="table admin-table">
                <thead>
                    <tr>
                        <th>Member</th>
                        <th>Role</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for tm in team_members %}
                    <tr>
                        <td>{{ tm.member.full_name }}</td>
                        <td>{{ 'Leader' if tm.is_leader else 'Member' }}</td>
                        <td class="text-end">
                            {% if not tm.is_leader %}
                            <form method="POST" action="{{ url_for('admin.teams_set_leader', team_id=team.id, team_member_id=tm.id) }}" class="d-inline">
                                <button type="submit" class="admin-btn admin-btn-outline admin-btn-sm">Make Leader</button>
                            </form>
                            {% endif %}
                            <form method="POST" action="{{ url_for('admin.teams_remove_member', team_id=team.id, team_member_id=tm.id) }}" class="d-inline">
                                <button type="submit" class="admin-btn admin-btn-outline admin-btn-sm">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center">No members assigned yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const input = document.getElementById('team_member_search');
    const hidden = document.getElementById('team_member_id');
    const results = document.getElementById('team_member_results');
    const loading = document.getElementById('team_member_loading');
    if (!input || !hidden || !results || !loading) return;

    let timer = null;
    function clearResults() { results.innerHTML = ''; }

    function render(items) {
        clearResults();
        if (!items.length) {
            results.innerHTML = '<div class="list-group-item text-muted">No members found</div>';
            return;
        }
        items.forEach((item) => {
            const row = document.createElement('button');
            row.type = 'button';
            row.className = 'list-group-item list-group-item-action';
            row.innerHTML = `<strong>${item.full_name}</strong><br><small>${item.member_id_number} â€¢ ${item.email}</small>`;
            row.addEventListener('click', () => {
                hidden.value = item.id;
                input.value = `${item.full_name} (${item.member_id_number})`;
                clearResults();
            });
            results.appendChild(row);
        });
    }

    input.addEventListener('input', function () {
        hidden.value = '';
        const q = this.value.trim();
        clearResults();
        if (!q) return;

        if (timer) clearTimeout(timer);
        timer = setTimeout(async () => {
            loading.classList.remove('d-none');
            try {
                const res = await fetch(`{{ url_for('admin.members_search') }}?q=${encodeURIComponent(q)}&limit=12`);
                const data = await res.json();
                render(data.results || []);
            } catch (e) {
                results.innerHTML = '<div class="list-group-item text-danger">Search failed</div>';
            } finally {
                loading.classList.add('d-none');
            }
        }, 260);
    });

    document.addEventListener('click', function (e) {
        if (!results.contains(e.target) && e.target !== input) clearResults();
    });
})();
</script>
{% endblock %}
